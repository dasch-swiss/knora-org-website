<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Knora API v2 Design &#8212; Knora 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Developing the Knora API Server" href="../development/index.html" />
    <link rel="prev" title="Administration (Users, Projects, Groups, Institutions, Permissions)" href="administration.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">Knora 0.1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="administration.html" title="Administration (Users, Projects, Groups, Institutions, Permissions)"
             accesskey="P">previous</a> |
          <a href="../development/index.html" title="Developing the Knora API Server"
             accesskey="N">next</a> |
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="knora-api-v2-design">
<h1>Knora API v2 Design<a class="headerlink" href="#knora-api-v2-design" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#general-principles" id="id2">General Principles</a></li>
<li><a class="reference internal" href="#api-schemas" id="id3">API Schemas</a></li>
<li><a class="reference internal" href="#implementation" id="id4">Implementation</a><ul>
<li><a class="reference internal" href="#json-ld-parsing-and-formatting" id="id5">JSON-LD Parsing and Formatting</a></li>
<li><a class="reference internal" href="#operation-wrappers" id="id6">Operation Wrappers</a></li>
<li><a class="reference internal" href="#smart-iris" id="id7">Smart IRIs</a><ul>
<li><a class="reference internal" href="#usage" id="id8">Usage</a></li>
<li><a class="reference internal" href="#id1" id="id9">Implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-principles">
<h2><a class="toc-backref" href="#id2">General Principles</a><a class="headerlink" href="#general-principles" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Knora API v2 requests and responses are RDF documents. Currently only <a class="reference external" href="http://json-ld.org/">JSON-LD</a>
documents are supported. Support for XML is planned.</li>
<li>Each class or property used in a request or response has a definition in an ontology, which
the Knora API server can serve.</li>
<li>Response formats are reused for different requests whenever possible, to minimise
the number of different response formats a client has to handle. For example,
any request for one or more resources (such as a search result, or a request for
one specific resource) returns a response in the same format.</li>
<li>Response size is limited by design. Large amounts of data must be retrieved by
requesting small pages of data, one after the other.</li>
<li>Responses that provide data are distinct from responses that provide definitions
(i.e. ontology entities). Data responses indicate which types are used, and the
client can request information about these types separately.</li>
</ul>
</div>
<div class="section" id="api-schemas">
<h2><a class="toc-backref" href="#id3">API Schemas</a><a class="headerlink" href="#api-schemas" title="Permalink to this headline">¶</a></h2>
<p>The types used in the triplestore are not exposed directly in the API. Instead, they are
mapped onto API &#8216;schemas&#8217;. Two schemas are currently provided.</p>
<ul class="simple">
<li>A default schema, which is suitable both for reading and for editing data. The default schema
represents values primarily as complex objects.</li>
<li>A simple schema, which is suitable for reading data but not for editing it. The simple schema
facilitates interoperability between Knora ontologies and non-Knora ontologies, since it
represents values primarily as literals.</li>
</ul>
<p>Each schema has its own type IRIs, which are derived from the ones used in the triplestore.
For details of these different IRI formats, see <a class="reference internal" href="../api_v2/knora-iris.html#knora-iris-v2"><span class="std std-ref">Knora IRIs</span></a>.</p>
</div>
<div class="section" id="implementation">
<h2><a class="toc-backref" href="#id4">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="json-ld-parsing-and-formatting">
<h3><a class="toc-backref" href="#id5">JSON-LD Parsing and Formatting</a><a class="headerlink" href="#json-ld-parsing-and-formatting" title="Permalink to this headline">¶</a></h3>
<p>Each API response is represented by a class that extends <code class="docutils literal"><span class="pre">KnoraResponseV2</span></code>, which
has a method <code class="docutils literal"><span class="pre">toJsonLDDocument</span></code> that specifies the target schema. It is currently
up to each route to determine what the appropriate response schema should be. Some routes
will support only one response schema. Others will allow the client to choose, and there will
be one or more standard ways for the client to specify the desired response schema.</p>
<p>A route calls <code class="docutils literal"><span class="pre">RouteUtilV2.runJsonRoute</span></code>, passing a request message and a response schema.
When <code class="docutils literal"><span class="pre">RouteUtilV2</span></code> gets the response message from the responder, it calls <code class="docutils literal"><span class="pre">toJsonLDDocument</span></code>
on it, specifying that schema. The response message returns a <code class="docutils literal"><span class="pre">JsonLDDocument</span></code>, which is
a simple data structure that is then converted to Java objects and passed to the JSON-LD
Java library for formatting. In general, <code class="docutils literal"><span class="pre">toJsonLDDocument</span></code> is implemented in two stages:
first the object converts itself to the target schema, and then the resulting object is
converted to a <code class="docutils literal"><span class="pre">JsonLDDocument</span></code>.</p>
<p>A route that receives JSON-LD requests should use <code class="docutils literal"><span class="pre">JsonLDUtil.parseJsonLD</span></code> to convert each
request to a <code class="docutils literal"><span class="pre">JsonLDDocument</span></code>.</p>
</div>
<div class="section" id="operation-wrappers">
<h3><a class="toc-backref" href="#id6">Operation Wrappers</a><a class="headerlink" href="#operation-wrappers" title="Permalink to this headline">¶</a></h3>
<p>Whenever possible, the same data structures are used for input and output. Often more data is
available in output than in input. For example, when a value is read from the triplestore, its IRI
is available, but when it is being created, it does not yet have an IRI. In such cases, there is a
class like <code class="docutils literal"><span class="pre">ValueContentV2</span></code>, which represents the data that is used both for input and for output.
When a value is read, a <code class="docutils literal"><span class="pre">ValueContentV2</span></code> is wrapped in a <code class="docutils literal"><span class="pre">ReadValueV2</span></code>, which additionally
contains the value&#8217;s IRI. When a value is created, it is wrapped in a <code class="docutils literal"><span class="pre">CreateValueV2</span></code>, which has
the resource IRI and the property IRI, but not the value IRI.</p>
<p>A <code class="docutils literal"><span class="pre">Read*</span></code> wrapper can be wrapped in another <code class="docutils literal"><span class="pre">Read*</span></code> wrapper; for example, a <code class="docutils literal"><span class="pre">ReadResourceV2</span></code>
contains <code class="docutils literal"><span class="pre">ReadValueV2</span></code> objects.</p>
<p>Each <code class="docutils literal"><span class="pre">*Content*</span></code> class should extend <code class="docutils literal"><span class="pre">KnoraContentV2</span></code> and thus have a <code class="docutils literal"><span class="pre">toOntologySchema</span></code> method
or converting itself between internal and external schemas, in either direction.</p>
<p>Each <code class="docutils literal"><span class="pre">Read*</span></code> wrapper class should have a method for converting itself to JSON-LD in a particular
external schema. If the <code class="docutils literal"><span class="pre">Read*</span></code> wrapper is a <code class="docutils literal"><span class="pre">KnoraResponseV2</span></code>, this method is
<code class="docutils literal"><span class="pre">toJsonLDDocument</span></code>.</p>
</div>
<div class="section" id="smart-iris">
<h3><a class="toc-backref" href="#id7">Smart IRIs</a><a class="headerlink" href="#smart-iris" title="Permalink to this headline">¶</a></h3>
<div class="section" id="usage">
<h4><a class="toc-backref" href="#id8">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">SmartIri</span></code> trait can be used to parse and validate IRIs, and in particular for converting Knora type
IRIs between internal and external schemas. It validates each IRI it parses. To use it, import the following:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.knora.webapi.util.</span><span class="o">{</span><span class="nc">SmartIri</span><span class="o">,</span> <span class="nc">StringFormatter</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.knora.webapi.util.IriConversions._</span>
</pre></div>
</div>
<p>Ensure that an implicit instance of <code class="docutils literal"><span class="pre">StringFormatter</span></code> is in scope:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">val</span> <span class="n">stringFormatter</span><span class="k">:</span> <span class="kt">StringFormatter</span> <span class="o">=</span> <span class="nc">StringFormatter</span><span class="o">.</span><span class="n">getGeneralInstance</span>
</pre></div>
</div>
<p>Then, if <code class="docutils literal"><span class="pre">iriStr</span></code> is a string representing an IRI, you can can convert it to a <code class="docutils literal"><span class="pre">SmartIri</span></code>
like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">iri</span><span class="k">:</span> <span class="kt">SmartIri</span> <span class="o">=</span> <span class="n">iriStr</span><span class="o">.</span><span class="n">toSmartIri</span>
</pre></div>
</div>
<p>If the IRI came from a request, use this method to throw a specific exception if the IRI
is invalid:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">iri</span><span class="k">:</span> <span class="kt">SmartIri</span> <span class="o">=</span> <span class="n">iriStr</span><span class="o">.</span><span class="n">toSmartIriWithErr</span><span class="o">(</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="nc">BadRequestException</span><span class="o">(</span><span class="s">s&quot;Invalid IRI: </span><span class="si">$iriStr</span><span class="s">&quot;</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>
</div>
<p>You can then use methods such as <code class="docutils literal"><span class="pre">SmartIri.isKnoraApiV2EntityIri</span></code> and <code class="docutils literal"><span class="pre">SmartIri.getProjectCode</span></code>
to obtain information about the IRI. To convert it to another schema, call <code class="docutils literal"><span class="pre">SmartIri.toOntologySchema</span></code>.
Converting a non-Knora IRI returns the same IRI.</p>
<p>If the IRI represents a Knora internal value class such as <code class="docutils literal"><span class="pre">knora-base:TextValue</span></code>, converting it to
the <code class="docutils literal"><span class="pre">ApiV2Simple</span></code> schema will return the corresponding simplified type, such as <code class="docutils literal"><span class="pre">xsd:string</span></code>. But this
conversion is not performed in the other direction (external to internal), since this would require
knowledge of the context in which the IRI is being used.</p>
<p>The performance penalty for using a <code class="docutils literal"><span class="pre">SmartIri</span></code> instead of a string is very small. Instances
are automatically cached once they are constructed. Parsing and caching a <code class="docutils literal"><span class="pre">SmartIri</span></code> instance takes
about 10-20 µs, and retrieving a cached <code class="docutils literal"><span class="pre">SmartIri</span></code> takes about 1 µs.</p>
<p>There is no advantage to using <code class="docutils literal"><span class="pre">SmartIri</span></code> for data IRIs, since they are not schema-specific (and are not
cached). If a data IRI has been received from a client request, it is better just to validate it using
<code class="docutils literal"><span class="pre">StringFormatter.validateAndEscapeIri</span></code>.</p>
</div>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id9">Implementation</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The smart IRI implementation, <code class="docutils literal"><span class="pre">SmartIriImpl</span></code>, is nested in the <code class="docutils literal"><span class="pre">StringFormatter</span></code> class, because
it uses the Knora API server&#8217;s hostname, which isn&#8217;t available until the Akka ActorSystem has
started. However, this means that the type of a <code class="docutils literal"><span class="pre">SmartIriImpl</span></code> instance is dependent on the instance
of <code class="docutils literal"><span class="pre">StringFormatter</span></code> that constructed it. Therefore, instances of <code class="docutils literal"><span class="pre">SmartIriImpl</span></code>
created by different instances of <code class="docutils literal"><span class="pre">StringFormatter</span></code> can&#8217;t be compared directly.</p>
<p>There are in fact two instances of <code class="docutils literal"><span class="pre">StringFormatter</span></code>:</p>
<ul class="simple">
<li>one returned by <code class="docutils literal"><span class="pre">StringFormatter.getGeneralInstance</span></code> which is available after Akka has started
and has the API server&#8217;s hostname (and can therefore provide <code class="docutils literal"><span class="pre">SmartIri</span></code> instances capable
of parsing IRIs containing that hostname). This instance is used throughout the Knora API
server.</li>
<li>one returned by <code class="docutils literal"><span class="pre">StringFormatter.getInstanceForConstantOntologies</span></code>, which is available before
Akka has started, and is used only by the hard-coded constant <code class="docutils literal"><span class="pre">knora-api</span></code> ontologies.</li>
</ul>
<p>This is the reason for the existence of the <code class="docutils literal"><span class="pre">SmartIri</span></code> trait, which is a top-level definition
and has its own <code class="docutils literal"><span class="pre">equals</span></code> and <code class="docutils literal"><span class="pre">hashCode</span></code> methods. Instances of <code class="docutils literal"><span class="pre">SmartIri</span></code> can thus be
compared (e.g. to use them as unique keys in collections), regardless of which instance of
<code class="docutils literal"><span class="pre">StringFormatter</span></code> created them.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../knora-ontologies/index.html">The Knora Ontologies</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Knora API Server</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../deployment/index.html">Getting started</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Knora API Server Design Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/index.html">Developing the Knora API Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_v1/index.html">Using API V1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_v2/index.html">Using API V2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../salsah/index.html">SALSAH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sipi/index.html">Sipi</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="administration.html" title="Administration (Users, Projects, Groups, Institutions, Permissions)"
              >previous</a> |
            <a href="../development/index.html" title="Developing the Knora API Server"
              >next</a> |
            <a href="../../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="../../../_sources/rst/knora-api-server/design-documentation/api-v2.rst.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Lukas Rosenthaler, Benjamin Geer, Ivan Subotic, Tobias Schweizer, André Kilchenmann, and Sepideh Alassi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>