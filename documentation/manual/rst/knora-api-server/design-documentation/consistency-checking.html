<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Consistency Checking &#8212; Knora 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Authentication in the Knora API Server" href="authentication.html" />
    <link rel="prev" title="Triplestore Updates" href="triplestore-updates.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">Knora 0.1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="triplestore-updates.html" title="Triplestore Updates"
             accesskey="P">previous</a> |
          <a href="authentication.html" title="Authentication in the Knora API Server"
             accesskey="N">next</a> |
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="consistency-checking">
<span id="id1"></span><h1>Consistency Checking<a class="headerlink" href="#consistency-checking" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://ontotext.com/products/graphdb/">Ontotext GraphDB</a> provides a mechanism for checking the consistency of data in
a repository each time an update transaction is committed. Knora provides
GraphDB-specific consistency rules that take advantage of this feature to
provide an extra layer of consistency checks, in addition to the checks that
are implemented in the Knora API server.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The Knora API server is designed to prevent inconsistencies in RDF data, as
far as is practical, in a triplestore-independent way (see
<a class="reference internal" href="triplestore-updates.html#triplestore-updates"><span class="std std-ref">Triplestore Updates</span></a>). However, it is also useful to enforce consistency
constraints in the triplestore itself, for two reasons:</p>
<ol class="arabic simple">
<li>To prevent inconsistencies resulting from bugs in the Knora API server.</li>
<li>To prevent users from inserting inconsistent data directly into the triplestore,
bypassing the Knora API server.</li>
</ol>
<p>The design of the <code class="docutils literal"><span class="pre">knora-base</span></code> ontology supports two ways of specifying constraints
on data (see <a class="reference internal" href="../../knora-ontologies/index.html#knora-ontologies"><span class="std std-ref">The Knora Ontologies</span></a> for details):</p>
<ol class="arabic simple">
<li>A property definition should specify the types that are allowed as subjects
and objects of the property, using <code class="docutils literal"><span class="pre">knora-base:subjectClassConstraint</span></code> and
(if it is an object property) <code class="docutils literal"><span class="pre">knora-base:objectClassConstraint</span></code>. Every subproperty of
<code class="docutils literal"><span class="pre">knora-base:hasValue</span></code> or a <code class="docutils literal"><span class="pre">knora-base:hasLinkTo</span></code> (i.e. every property of a resource
that points to a <code class="docutils literal"><span class="pre">knora-base:Value</span></code> or to another resource) is required have this constraint,
because the Knora API server relies on it to know what type of object to expect for the property.
Use of <code class="docutils literal"><span class="pre">knora-base:subjectClassConstraint</span></code> is recommended but not required.</li>
<li>A class definition should use OWL cardinalities (see
<a class="reference external" href="https://www.w3.org/TR/owl2-quick-reference/">OWL 2 Quick Reference Guide</a>) to indicate the properties that instances of
the class are allowed to have, and to constrain the number of objects that each
property can have. Subclasses of <code class="docutils literal"><span class="pre">knora-base:Resource</span></code> are required to have
a cardinality for each subproperty of <code class="docutils literal"><span class="pre">knora-base:hasValue</span></code> or a <code class="docutils literal"><span class="pre">knora-base:hasLinkTo</span></code>
that resources of that class can have.</li>
</ol>
<p>Specifically, consistency checking should prevent the following:</p>
<ul class="simple">
<li>An object property or datatype property has a subject of the wrong class, or an
object property has an object of the wrong class (GraphDB&#8217;s consistency checke
cannot check the types of literals).</li>
<li>An object property has an object that does not exist (i.e. the object is an IRI
that is not used as the subject of any statements in the repository). This can be treated
as if the object is of the wrong type (i.e. it can cause a violation of
<code class="docutils literal"><span class="pre">knora-base:objectClassConstraint</span></code>, because there is no compatible <code class="docutils literal"><span class="pre">rdf:type</span></code> statement
for the object).</li>
<li>A class has <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code> or <code class="docutils literal"><span class="pre">owl:minCardinality</span> <span class="pre">1</span></code> on an object property
or datatype property, and an instance of the class does not have that property.</li>
<li>A class has <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code> or <code class="docutils literal"><span class="pre">owl:maxCardinality</span> <span class="pre">1</span></code> on an object property
or datatype property, and an instance of the class has more than one object for that
property.</li>
<li>An instance of <code class="docutils literal"><span class="pre">knora-base:Resource</span></code> has an object property pointing to a
<code class="docutils literal"><span class="pre">knora-base:Value</span></code> or to another <code class="docutils literal"><span class="pre">Resource</span></code>, and its class has no cardinality
for that property.</li>
<li>An instance of <code class="docutils literal"><span class="pre">knora-base:Value</span></code> has a subproperty of <code class="docutils literal"><span class="pre">knora-base:valueHas</span></code>,
and its class has no cardinality for that property.</li>
<li>A datatype property has an empty string as an object.</li>
</ul>
<p>Cardinalities in base classes are inherited by derived classes. Derived classes
can override inherited cardinalities by making them more restrictive, i.e. by specifying
a subproperty of the one specified in the original cardinality.</p>
<p>Instances of <code class="docutils literal"><span class="pre">Resource</span></code> and <code class="docutils literal"><span class="pre">Value</span></code> can be marked as deleted, using the property
<code class="docutils literal"><span class="pre">isDeleted</span></code>. This must be taken into account as follows:</p>
<ul class="simple">
<li>With <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code> or <code class="docutils literal"><span class="pre">owl:maxCardinality</span> <span class="pre">1</span></code>, if the object of the
property can be marked as deleted, the property must not have more than one object that has
not been marked as deleted. In other words, it&#8217;s OK if there is more than one object, as
long only one of them has <code class="docutils literal"><span class="pre">knora-base:isDeleted</span> <span class="pre">false</span></code>.</li>
<li>With <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code> or <code class="docutils literal"><span class="pre">owl:minCardinality</span> <span class="pre">1</span></code>, the property must
have an object, but it&#8217;s OK if the property&#8217;s only object is marked as deleted.
We allow this because the subject and object may have different owners, and it may
not be feasible for them to coordinate their work. The owner of the object
should always be able to mark it as deleted. (It could be useful to notify
the owner of the subject when this happens, but that is beyond the scope of
consistency checking.)</li>
</ul>
</div>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>When a repository is created in GraphDB, a set of consistency rules can be
provided, and GraphDB&#8217;s consistency checker can be turned on to ensure that
each update transaction respects these rules, as described in the section
<a class="reference external" href="http://graphdb.ontotext.com/documentation/standard/reasoning.html">Reasoning</a> of the GraphDB documentation. Like custom inference rules,
consistency rules are defined in files with the <code class="docutils literal"><span class="pre">.pie</span></code> filename extension,
in a GraphDB-specific syntax.</p>
<p>We have added rules to the standard RDFS inference rules file
<code class="docutils literal"><span class="pre">builtin_RdfsRules.pie</span></code>, to create the file <code class="docutils literal"><span class="pre">KnoraRules.pie</span></code>. The <code class="docutils literal"><span class="pre">.ttl</span></code>
configuration file that is used to create the repository must contain these
settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">owlim</span><span class="p">:</span><span class="n">ruleset</span> <span class="s2">&quot;/path/to/KnoraRules.pie&quot;</span> <span class="p">;</span>
<span class="n">owlim</span><span class="p">:</span><span class="n">check</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">inconsistencies</span> <span class="s2">&quot;true&quot;</span> <span class="p">;</span>
</pre></div>
</div>
<p>The path to <code class="docutils literal"><span class="pre">KnoraRules.pie</span></code> must be an absolute path. The scripts provided
with Knora to create test repositories set this path automatically.</p>
<p>Consistency checking in GraphDB relies on reasoning. GraphDB&#8217;s reasoning
is <a class="reference external" href="http://graphdb.ontotext.com/documentation/standard/introduction-to-semantic-web.html#reasoning-strategies">Forward-chaining</a>, which means that reasoning is applied to the contents
of each update, before the update transaction is committed, and the inferred
statements are added to the repository.</p>
<p>A GraphDB rules file can contain two types of rules: inference rules and
consistency rules. Before committing an update transaction, GraphDB applies
inference rules, then consistency rules. If any of the consistency rules are
violated, the transaction is rolled back.</p>
<p>An inference rule has this form:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Id</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">rule_name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">premises</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">optional_constraints</span><span class="o">&gt;</span>
    <span class="o">-------------------------------</span>
    <span class="o">&lt;</span><span class="n">consequences</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">optional_constraints</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The premises are a pattern that tries to match statements found in the data.
Optional constraints, which are enclosed in square brackets, make it possible
to specify the premises more precisely, or to specify a named graph (see
examples below). Consequences are the statements that will be inferred if the
premises match. A line of hyphens separates premises from consequences.</p>
<p>A GraphDB consistency rule has a similar form:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">rule_name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">premises</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">optional_constraints</span><span class="o">&gt;</span>
    <span class="o">-------------------------------</span>
    <span class="o">&lt;</span><span class="n">consequences</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">optional_constraints</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The differences between inference rules and consistency rules are:</p>
<ul class="simple">
<li>A consistency rule begins with <code class="docutils literal"><span class="pre">Consistency</span></code> instead of <code class="docutils literal"><span class="pre">Id</span></code>.</li>
<li>In a consistency rule, the consequences are optional. Instead of representing
statements to be inferred, they represent statements that must exist if the premises
are satisfied. In other words, if the premises are satisfied and the consequences
are not found, the rule is violated.</li>
<li>If a consistency rule doesn&#8217;t specify any consequences, and the premises are
satisfied, the rule is violated.</li>
</ul>
<p>Rules use variable names for subjects, predicates, and objects, and they can use actual
property names.</p>
<div class="section" id="empty-string-as-object">
<h3>Empty string as object<a class="headerlink" href="#empty-string-as-object" title="Permalink to this headline">¶</a></h3>
<p>If subject <code class="docutils literal"><span class="pre">i</span></code> has a predicate <code class="docutils literal"><span class="pre">p</span></code> whose object is an empty string,
the constraint is violated:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">empty_string</span>
    <span class="n">i</span> <span class="n">p</span> <span class="s2">&quot;&quot;</span>
    <span class="o">------------------------------------</span>
</pre></div>
</div>
</div>
<div class="section" id="subject-and-object-class-constraints">
<h3>Subject and object class constraints<a class="headerlink" href="#subject-and-object-class-constraints" title="Permalink to this headline">¶</a></h3>
<p>If subject <code class="docutils literal"><span class="pre">i</span></code> has a predicate <code class="docutils literal"><span class="pre">p</span></code> that requires a subject of type <code class="docutils literal"><span class="pre">t</span></code>,
and <code class="docutils literal"><span class="pre">i</span></code> is not a <code class="docutils literal"><span class="pre">t</span></code>, the constraint is violated:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">subject_class_constraint</span>
    <span class="n">p</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">subjectClassConstraint</span><span class="o">&gt;</span> <span class="n">t</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="o">&lt;</span><span class="n">rdf</span><span class="p">:</span><span class="nb">type</span><span class="o">&gt;</span> <span class="n">t</span>
</pre></div>
</div>
<p>If subject <code class="docutils literal"><span class="pre">i</span></code> has a predicate <code class="docutils literal"><span class="pre">p</span></code> that requires an object of type <code class="docutils literal"><span class="pre">t</span></code>,
and the object of <code class="docutils literal"><span class="pre">p</span></code> is not a <code class="docutils literal"><span class="pre">t</span></code>, the constraint is violated:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">object_class_constraint</span>
    <span class="n">p</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">objectClassConstraint</span><span class="o">&gt;</span> <span class="n">t</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
    <span class="o">------------------------------------</span>
    <span class="n">j</span> <span class="o">&lt;</span><span class="n">rdf</span><span class="p">:</span><span class="nb">type</span><span class="o">&gt;</span> <span class="n">t</span>
</pre></div>
</div>
</div>
<div class="section" id="cardinality-constraints">
<h3>Cardinality constraints<a class="headerlink" href="#cardinality-constraints" title="Permalink to this headline">¶</a></h3>
<p>A simple implementation of a consistency rule to check <code class="docutils literal"><span class="pre">owl:maxCardinality</span>
<span class="pre">1</span></code>, for objects that can be marked as deleted, could look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">max_cardinality_1_with_deletion_flag</span>
    <span class="n">i</span> <span class="o">&lt;</span><span class="n">rdf</span><span class="p">:</span><span class="nb">type</span><span class="o">&gt;</span> <span class="n">r</span>
    <span class="n">r</span> <span class="o">&lt;</span><span class="n">owl</span><span class="p">:</span><span class="n">maxCardinality</span><span class="o">&gt;</span> <span class="s2">&quot;1&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">nonNegativeInteger</span>
    <span class="n">r</span> <span class="o">&lt;</span><span class="n">owl</span><span class="p">:</span><span class="n">onProperty</span><span class="o">&gt;</span> <span class="n">p</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">k</span> <span class="p">[</span><span class="n">Constraint</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="n">k</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="o">------------------------------------</span>
</pre></div>
</div>
<p>This means: if resource <code class="docutils literal"><span class="pre">i</span></code> is a subclass of an <code class="docutils literal"><span class="pre">owl:Restriction</span></code> <code class="docutils literal"><span class="pre">r</span></code>
with <code class="docutils literal"><span class="pre">owl:maxCardinality</span> <span class="pre">1</span></code> on property <code class="docutils literal"><span class="pre">p</span></code>, and the resource has two
different objects for that property, neither of which is marked as
deleted, the rule is violated. Note that this takes advantage of the
fact that <code class="docutils literal"><span class="pre">Resource</span></code> and <code class="docutils literal"><span class="pre">Value</span></code> have <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code> on <code class="docutils literal"><span class="pre">isDeleted</span></code>
(<code class="docutils literal"><span class="pre">isDeleted</span></code> must be present even if false), so we do not need to check
whether <code class="docutils literal"><span class="pre">i</span></code> is actually something that can be marked as deleted.</p>
<p>However, this implementation would be much too slow. We therefore use
two optimisations suggested by Ontotext:</p>
<ol class="arabic simple">
<li>Add custom inference rules to make tables (i.e. named graphs) of pre-calculated
information about the cardinalities on properties of subjects,
and use those tables to simplify the consistency rules.</li>
<li>Use the <code class="docutils literal"><span class="pre">[Cut]</span></code> constraint to avoid generating certain redundant compiled rules
(see <a class="reference external" href="http://graphdb.ontotext.com/documentation/standard/reasoning.html#entailment-rules">Entailment rules</a>).</li>
</ol>
<p>For example, to construct a table of subjects belonging to classes that have
<code class="docutils literal"><span class="pre">owl:maxCardinality</span> <span class="pre">1</span></code> on some property <code class="docutils literal"><span class="pre">p</span></code>, we use the following custom
inference rule:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Id</span><span class="p">:</span> <span class="n">maxCardinality_1_table</span>
    <span class="n">i</span> <span class="o">&lt;</span><span class="n">rdf</span><span class="p">:</span><span class="nb">type</span><span class="o">&gt;</span> <span class="n">r</span>
    <span class="n">r</span> <span class="o">&lt;</span><span class="n">owl</span><span class="p">:</span><span class="n">maxCardinality</span><span class="o">&gt;</span> <span class="s2">&quot;1&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">nonNegativeInteger</span>
    <span class="n">r</span> <span class="o">&lt;</span><span class="n">owl</span><span class="p">:</span><span class="n">onProperty</span><span class="o">&gt;</span> <span class="n">p</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_maxCardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>The constraint <code class="docutils literal"><span class="pre">[Context</span> <span class="pre">&lt;onto:_maxCardinality_1_table&gt;]</span></code> means that the
inferred triples are added to the context (i.e. the named graph)
<code class="docutils literal"><span class="pre">http://www.ontotext.com/_maxCardinality_1_table</span></code>.  (Note that we have defined the prefix
<code class="docutils literal"><span class="pre">onto</span></code> as <code class="docutils literal"><span class="pre">http://www.ontotext.com/</span></code> in the <code class="docutils literal"><span class="pre">Prefices</span></code> section of the rules file.)
As the GraphDB documentation on <a class="reference external" href="http://graphdb.ontotext.com/documentation/standard/reasoning.html#rules">Rules</a> explains:</p>
<blockquote>
<div>If the context is provided, the statements produced as rule consequences are
not ‘visible’ during normal query answering. Instead, they can only be used as
input to this or other rules and only when the rule premise explicitly uses
the given context.</div></blockquote>
<p>Now, to find out whether a subject belongs to a class with that cardinality on
a given property, we only need to match one triple. The revised implementation
of the rule <code class="docutils literal"><span class="pre">max_cardinality_1_with_deletion_flag</span></code> is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">max_cardinality_1_with_deletion_flag</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_maxCardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span> <span class="p">[</span><span class="n">Constraint</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">k</span> <span class="p">[</span><span class="n">Cut</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="n">k</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="o">------------------------------------</span>
</pre></div>
</div>
<p>The constraint <code class="docutils literal"><span class="pre">[Constraint</span> <span class="pre">j</span> <span class="pre">!=</span> <span class="pre">k]</span></code> means that the premises will be satisfied only
if the variables <code class="docutils literal"><span class="pre">j</span></code> and <code class="docutils literal"><span class="pre">k</span></code> do not refer to the same thing.</p>
<p>With these optimisations, the rule is faster by several orders of magnitude.</p>
<p>Since properties whose objects can be marked as deleted must be handled differently
to properties whose objects cannot be marked as deleted, the <code class="docutils literal"><span class="pre">knora-base</span></code> ontology
provides a property called <code class="docutils literal"><span class="pre">objectCannotBeMarkedAsDeleted</span></code>. All properties in
<code class="docutils literal"><span class="pre">knora-base</span></code> whose objects cannot take the <code class="docutils literal"><span class="pre">isDeleted</span></code> flag (including datatype
properties) should be derived from this property. This is how it is used to check
<code class="docutils literal"><span class="pre">owl:maxCardinality</span> <span class="pre">1</span></code> for objects that cannot be marked as deleted:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">max_cardinality_1_without_deletion_flag</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_maxCardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">&lt;</span><span class="n">rdfs</span><span class="p">:</span><span class="n">subPropertyOf</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">objectCannotBeMarkedAsDeleted</span><span class="o">&gt;</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span> <span class="p">[</span><span class="n">Constraint</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">k</span> <span class="p">[</span><span class="n">Cut</span><span class="p">]</span>
    <span class="o">------------------------------------</span>
</pre></div>
</div>
<p>To check <code class="docutils literal"><span class="pre">owl:minCardinality</span> <span class="pre">1</span></code>, we do not care whether the object can
be marked as deleted, so we can use this simple rule:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">min_cardinality_1_any_object</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_minCardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
</pre></div>
</div>
<p>This means: if a subject <code class="docutils literal"><span class="pre">i</span></code> belongs to a class that has
<code class="docutils literal"><span class="pre">owl:minCardinality</span> <span class="pre">1</span></code> on property <code class="docutils literal"><span class="pre">p</span></code>, and <code class="docutils literal"><span class="pre">i</span></code> has no object for <code class="docutils literal"><span class="pre">p</span></code>,
the rule is violated.</p>
<p>To check <code class="docutils literal"><span class="pre">owl:cardinality</span> <span class="pre">1</span></code>, we need two rules: one that checks whether
there are too few objects, and one that checks whether there are too many.
To check whether there are too few objects, we don&#8217;t care whether the objects
can be marked as deleted, so the rule is the same as
<code class="docutils literal"><span class="pre">min_cardinality_1_any_object</span></code>, except for the cardinality:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">cardinality_1_not_less_any_object</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_cardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
</pre></div>
</div>
<p>To check whether there are too many objects, we need to know whether
the objects can be marked as deleted or not. In the case where the objects
can be marked as deleted, the rule is the same as
<code class="docutils literal"><span class="pre">max_cardinality_1_with_deletion_flag</span></code>, except for the cardinality:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">cardinality_1_not_greater_with_deletion_flag</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_cardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span> <span class="p">[</span><span class="n">Constraint</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">k</span> <span class="p">[</span><span class="n">Cut</span><span class="p">]</span>
    <span class="n">j</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="n">k</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">isDeleted</span><span class="o">&gt;</span> <span class="s2">&quot;false&quot;</span><span class="o">^^</span><span class="n">xsd</span><span class="p">:</span><span class="n">boolean</span>
    <span class="o">------------------------------------</span>
</pre></div>
</div>
<p>In the case where the objects cannot be marked as deleted, the rule is the
same as <code class="docutils literal"><span class="pre">max_cardinality_1_without_deletion_flag</span></code>, except for the
cardinality:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">cardinality_1_not_less_any_object</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">r</span> <span class="p">[</span><span class="n">Context</span> <span class="o">&lt;</span><span class="n">onto</span><span class="p">:</span><span class="n">_cardinality_1_table</span><span class="o">&gt;</span><span class="p">]</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
</pre></div>
</div>
<p>Knora allows a subproperty of <code class="docutils literal"><span class="pre">knora-base:hasValue</span></code> or
<code class="docutils literal"><span class="pre">knora-base:hasLinkTo</span></code> to be a predicate of a resource only if the resource&#8217;s
class has some cardinality for the property. For convenience,
<code class="docutils literal"><span class="pre">knora-base:hasValue</span></code> and <code class="docutils literal"><span class="pre">knora-base:hasLinkTo</span></code> are subproperties of
<code class="docutils literal"><span class="pre">knora-base:resourceProperty</span></code>, which is used to check this constraint in the
following rule:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Consistency</span><span class="p">:</span> <span class="n">resource_prop_cardinality_any</span>
    <span class="n">i</span> <span class="o">&lt;</span><span class="n">knora</span><span class="o">-</span><span class="n">base</span><span class="p">:</span><span class="n">resourceProperty</span><span class="o">&gt;</span> <span class="n">j</span>
    <span class="o">------------------------------------</span>
    <span class="n">i</span> <span class="n">p</span> <span class="n">j</span>
    <span class="n">i</span> <span class="o">&lt;</span><span class="n">rdf</span><span class="p">:</span><span class="nb">type</span><span class="o">&gt;</span> <span class="n">r</span>
    <span class="n">r</span> <span class="o">&lt;</span><span class="n">owl</span><span class="p">:</span><span class="n">onProperty</span><span class="o">&gt;</span> <span class="n">p</span>
</pre></div>
</div>
<p>If resource <code class="docutils literal"><span class="pre">i</span></code> has a subproperty of <code class="docutils literal"><span class="pre">knora-base:resourceProperty</span></code>,
and <code class="docutils literal"><span class="pre">i</span></code> is not a member of a subclass of an <code class="docutils literal"><span class="pre">owl:Restriction</span></code> <code class="docutils literal"><span class="pre">r</span></code>
with a cardinality on that property (or on one of its base
properties), the rule is violated.</p>
<p>A similar rule, <code class="docutils literal"><span class="pre">value_prop_cardinality_any</span></code>, ensures that if a value has
a subproperty of <code class="docutils literal"><span class="pre">knora-base:valueHas</span></code>, the value&#8217;s class has some cardinality
for that property.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../knora-ontologies/index.html">The Knora Ontologies</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Knora API Server</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../deployment/index.html">Getting started</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Knora API Server Design Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/index.html">Developing the Knora API Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_v1/index.html">Using API V1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_v2/index.html">Using API V2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../salsah/index.html">SALSAH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sipi/index.html">Sipi</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="triplestore-updates.html" title="Triplestore Updates"
              >previous</a> |
            <a href="authentication.html" title="Authentication in the Knora API Server"
              >next</a> |
            <a href="../../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="../../../_sources/rst/knora-api-server/design-documentation/consistency-checking.rst.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Lukas Rosenthaler, Benjamin Geer, Ivan Subotic, Tobias Schweizer, André Kilchenmann, and Sepideh Alassi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>